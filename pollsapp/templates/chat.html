<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Section</title>
</head>
<body>
    <div class="navbar">
        <a href="{% url 'dashboard' email=email %}">DASHBOARD</a>
        <a href="{% url 'post' email=email %}">POST</a>
        <a href="{% url 'chat' email=email %}">CHAT</a>
        <a href="{% url 'official' email=email %}">OFFICIAL</a>
        <a href="/profile">PROFILE</a>
        <a href="{% url 'logout' email=email %}">LOGOUT</a>
    </div>
    <div class="chatlist">
        <input type="text" name="name" id="name" placeholder="Search for a user to chat with">
        <input type="submit" value="Search" onclick="userSearch()">
        <div class="searchedUsers"></div>
    </div>
    <div class="recentchats">
        <h2>Recently Contacted</h2>
        {% for chat in recentChatsData %}
            <button onclick="startChat('{{ chat.other }}')">
            <div class="chat">
                <h4>{{ chat.other }}</h4>
                <p>{{ chat.message }}</p>
            </div>
            </button>
            <br>
        {% empty %}
            <p>No recent chats.</p>
        {% endfor %}
    </div>
    <div class="chatarea">
        <div class="namearea"></div>
        <div class="chatsarea"></div>
        <div class="textArea"></div>
    </div>
</body>

<script>
    const senderEmail = `{{ email }}`;
    let currentReceiver = null;
    const renderedKeys = new Set();

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            document.cookie.split(";").forEach(c => {
                c = c.trim();
                if (c.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(c.slice(name.length + 1));
                }
            });
        }
        return cookieValue;
    }

    function messageKey(m) {
        return `${m.senderemail}|${m.time}|${m.message}`;
    }

    function fetchChats() {
        if (!currentReceiver) return;

        fetch("/get-chats/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({
                senderEmail,
                receiverEmail: currentReceiver
            })
        })
        .then(res => res.json())
        .then(data => {
            const area = document.querySelector(".chatsarea");
            data.messages.forEach(msg => {
                const key = messageKey(msg);
                if (renderedKeys.has(key)) return; 
                renderedKeys.add(key);

                const wrapper = document.createElement("div");
                wrapper.className = "chat";
                wrapper.style.backgroundColor =
                msg.senderemail === senderEmail ? "#d1e7dd" : "#f8d7da";

                const who = document.createElement("h4");
                who.textContent =
                msg.senderemail === senderEmail ? "You" : msg.senderemail;

                const text = document.createElement("p");
                text.textContent = msg.message;
                text.style.textAlign =
                msg.senderemail === senderEmail ? "right" : "left";

                wrapper.append(who, text);
                area.append(wrapper);
            });

            area.scrollTop = area.scrollHeight;
        })
        .catch(console.error);
    }

    setInterval(fetchChats, 2000);

    function userSearch() {
        const input = document.getElementById("name").value;
        fetch("/chat-search/", {
            method : "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ name: input })
        })
        .then(res => res.json())
        .then(data => {
        const list = document.querySelector(".searchedUsers");
        list.innerHTML = data.results.map(u => `
            <div class="user" id="${u.email}">
            ${u.name}
            <button onclick="startChat('${u.email}')">Start Chat</button>
            </div>
        `).join("");
        })
        .catch(console.error);
  }

  function startChat(receiverEmail) {
        currentReceiver = receiverEmail;
        renderedKeys.clear();

        document.querySelector(".namearea").innerHTML = `<h3>${receiverEmail}</h3>`;
        document.querySelector(".chatsarea").innerHTML = "";
        document.querySelector(".textArea").innerHTML = `
            <textarea id="message" placeholder="Type your message"></textarea>
            <button id="sendBtn">Send</button>
        `;

        document.getElementById("sendBtn").onclick = () => sendMessage(receiverEmail);

        fetchChats();
    }

    function sendMessage(receiverEmail) {
        const input = document.getElementById("message");
        const message = input.value.trim();
        if (!message) return;

        fetch("/send-message/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({
                senderEmail,
                receiverEmail,
                message
            })
        })
        .then(res => res.json())
        .then(() => {
            input.value = "";
            fetchChats();
        })
        .catch(console.error);
    }
</script>
</html>