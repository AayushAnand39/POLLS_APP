<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Examination</title>
</head>
<body>
    <div class="navbar">
        <a href="{% url 'dashboard' email=email %}">DASHBOARD</a>
        <a href="{% url 'post' email=email %}">POST</a>
        <a href="{% url 'chat' email=email %}">CHAT</a>
        <a href="{% url 'official' email=email %}">OFFICIAL</a>
        <a href="/profile">PROFILE</a>
        <a href="{% url 'logout' email=email %}">LOGOUT</a>
    </div>
    <div class="officialsection">
        <a href="{% url 'createexam' email=email %}">CREATE EXAMINATION</a>
        <a href="/conductvote">CONDUCT A VOTE</a>
        <a href="{% url 'attendexam' email=email %}">ATTEND EXAMINATION</a>
    </div>
    <div class="questions">
        <form action="{% url 'createexam' email=email %}" method="post" onsubmit="return createExamQuestions(event)">
            <!-- {% csrf_token %} -->
            <input type="text" name="name" id="name" placeholder="Enter the name of the exam creator"><br>
            <input type="email" name="email" id="email" placeholder="Enter the email of the exam creator"><br>
            <input type="text" name="institution" id="institution" placeholder="Enter the institution you are affiliated with"><br>
            <input type="text" name="phonenumber" id="phonenumber" placeholder="Enter your phone number"><br>
            <input type="number" name="number" id="number" placeholder="Enter the number of questions"><br>
            <input type="date" name="date" id="date" placeholder="Enter the starting date"><br>
            <input type="time" name="starttime" id="starttime" placeholder="Enter the starting time of the examination"><br>
            <input type="time" name="endtime" id="endtime" placeholder="Enter the ending time of the examination"><br>
            <input type="text" name="description" id="description" placeholder="Enter the description of this examination"><br>
            <input type="submit" value="Create exam">
        </form>
    </div>
</body>
<script>
  // CSRF helper (unchanged)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            document.cookie.split(";").forEach(c => {
                c = c.trim();
                if (c.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(c.slice(name.length + 1));
                }
            });
        }
        return cookieValue;
    }

  // In‑memory state, plus metadata
    let examid         = null;
    let questionCount  = 0;
    let currentIndex   = 1;
    let metadata       = {};     // { name, email, institution, phonenumber, number, date, starttime, endtime, description }
    const questionsCache = {};   // questionsCache[q] = {...}
    const questionPK     = {};   // questionPK[q] = db pk

    function persistState() {
        sessionStorage.setItem("metadata",      JSON.stringify(metadata));
        sessionStorage.setItem("examid",        examid);
        sessionStorage.setItem("questionCount", questionCount);
        sessionStorage.setItem("currentIndex",  currentIndex);
        sessionStorage.setItem("questionsCache",JSON.stringify(questionsCache));
        sessionStorage.setItem("questionPK",    JSON.stringify(questionPK));
    }

    function restoreState() {
        const m = sessionStorage.getItem("metadata");
        if (!m) return false;
        metadata       = JSON.parse(m);
        examid         = sessionStorage.getItem("examid");
        questionCount  = parseInt(sessionStorage.getItem("questionCount"), 10);
        currentIndex   = parseInt(sessionStorage.getItem("currentIndex"), 10);
        Object.assign(questionsCache, JSON.parse(sessionStorage.getItem("questionsCache")  || "{}"));
        Object.assign(questionPK,     JSON.parse(sessionStorage.getItem("questionPK")      || "{}"));
        return true;
    }

    // initial metadata form submit
    async function createExamQuestions(e) {
        e.preventDefault();
        metadata = Object.fromEntries(new FormData(e.target).entries());
        questionCount = parseInt(metadata.number, 10);

        // send metadata
        const resp = await fetch("/send-data/", {
            method: "POST",
            headers: {
                "Content-Type":"application/json",
                "X-CSRFToken":getCookie("csrftoken")
            },
            body: JSON.stringify({ formData: metadata })
        });
        const js = await resp.json();
        examid = js.examid;

        // init empty question slots
        for (let i = 1; i <= questionCount; i++) {
            questionsCache[i] = {
                question: "", option1: "", option2: "",
                option3: "", option4: "",
                positive: "", negative: "", correct: ""
            };
        }

        persistState();
        renderQuestion(1);
    }

    // render question #q
    function renderQuestion(q) {
        currentIndex = q;
        persistState();

        const slot = questionsCache[q] || {};
        const cont = document.querySelector(".questions");
        cont.innerHTML = `
        <h4>Exam ID: ${examid}</h4>
        <h4>Question ${q} of ${questionCount}</h4>
        <form id="qform">
            <input type="text"   name="question"  value="${slot.question}" placeholder="Question"><br>
            <input type="text"   name="option1"   value="${slot.option1}"  placeholder="Option 1"><br>
            <input type="text"   name="option2"   value="${slot.option2}"  placeholder="Option 2"><br>
            <input type="text"   name="option3"   value="${slot.option3}"  placeholder="Option 3"><br>
            <input type="text"   name="option4"   value="${slot.option4}"  placeholder="Option 4"><br>
            <input type="number" name="positive"  value="${slot.positive}" placeholder="Score +ve"><br>
            <input type="number" name="negative"  value="${slot.negative}" placeholder="Score –ve"><br>
            <input type="number" name="correct"   value="${slot.correct}"  placeholder="Correct option (1–4)"><br>
            <button type="submit">Save</button>
        </form>
        <button id="prevBtn" ${q===1 ? "disabled" : ""}>Previous</button>
        ${
            q < questionCount
            ? `<button id="nextBtn">Next</button>`
            : `
            <button id="verifyBtn">Verify Details</button>
            <button id="submitBtn">Submit Exam</button>
            `
        }
        `;

        // handlers
        document.getElementById("qform").onsubmit = e => sendQuestion(e, q);
        if (q > 1) document.getElementById("prevBtn").onclick = () => renderQuestion(q-1);
        if (q < questionCount) document.getElementById("nextBtn").onclick = () => renderQuestion(q+1);
        else {
            // On last question: Verify and Submit
            document.getElementById("verifyBtn").onclick = () => {
                // clear question state, keep metadata
                sessionStorage.removeItem("examid");
                sessionStorage.removeItem("questionCount");
                sessionStorage.removeItem("currentIndex");
                sessionStorage.removeItem("questionsCache");
                sessionStorage.removeItem("questionPK");
                // reload to show metadata form prefilled
                window.location.reload();
            };
            document.getElementById("submitBtn").onclick = () => {
                // final submit: clear all and go to dashboard
                sessionStorage.clear();
                window.location.href = "{% url 'dashboard' email=email %}";
            };
        }
    }

    // save or update a question
    async function sendQuestion(e, qnum) {
        e.preventDefault();
        const dataObj = Object.fromEntries(new FormData(e.target).entries());
        questionsCache[qnum] = dataObj;
        persistState();

        const payload = { examid, questionnumber: qnum, formData: dataObj };
        if (questionPK[qnum]) payload.pk = questionPK[qnum];

        const resp = await fetch("/send-exam-question/", {
            method: "POST",
            headers: {
                "Content-Type":"application/json",
                "X-CSRFToken":getCookie("csrftoken")
            },
            body: JSON.stringify(payload)
        });
        const js = await resp.json();
        if (js.pk) {
            questionPK[qnum] = js.pk;
            persistState();
        }
        alert(`Question ${qnum} saved!`);
    }

    document.addEventListener("DOMContentLoaded", () => {
        if (restoreState()) renderQuestion(currentIndex);
        else {
        // first‑time: metadata form
            document.querySelector("form").onsubmit = createExamQuestions;
            // if you had saved metadata previously, prefill it:
            const saved = sessionStorage.getItem("metadata");
            if (saved) {
                const m = JSON.parse(saved);
                Object.entries(m).forEach(([k,v])=>{
                const inp = document.getElementById(k);
                if (inp) inp.value = v;
                });
            }
        }
    });
</script>
</html> 