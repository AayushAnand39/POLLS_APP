<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <style>
    .navbar a { margin-right: 1em; }
    .poll { border: 1px solid #ccc; padding: 1em; margin-bottom: 2em; position: relative; }
    .poll-header { display: flex; align-items: center; margin-bottom: 0.5em; }
    .poll-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
    .poll-actions { position: absolute; top: 1em; right: 1em; }
    .poll-actions button { background: none; border: none; font-size: 1.1em; margin-left: 0.5em; cursor: pointer; }
    .poll-options h4 { display: flex; align-items: center; margin-bottom: 0.6em; }
    .poll-options img { max-height: 35px; margin-left: 10px; }
    .vote-btn { margin-right: 10px; }
    .question-image { margin-top: 0.6em; max-width: 100%; max-height: 200px; }
    .disabled { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="{% url 'dashboard' email=email %}">DASHBOARD</a>
    <a href="{% url 'post' email=email %}">POST</a>
    <a href="{% url 'chat' email=email %}">CHAT</a>
    <a href="{% url 'official' email=email %}">OFFICIAL</a>
    <a href="/profile">PROFILE</a>
    <a href="{% url 'logout' email=email %}">LOGOUT</a>
  </div>

  <h1>Welcome, {{ name }}</h1>

  {% for poll in polls %}
    <div class="poll" data-qn="{{ poll.questionid }}">

      <!-- Like / Dislike -->
      <div class="poll-actions">
        <button type="button"
                class="like-btn"
                data-qn="{{ poll.questionid }}"
                title="Like">
          üëç <span id="like-count-{{ poll.questionid }}">{{ poll.likes }}</span>
        </button>
        <button type="button"
                class="dislike-btn"
                data-qn="{{ poll.questionid }}"
                title="Dislike">
          üëé <span id="dislike-count-{{ poll.questionid }}">{{ poll.dislikes }}</span>
        </button>
      </div>

      <div class="poll-header">
        <img src="{{ poll.author_photo }}" alt="{{ poll.author_name }}‚Äôs avatar" />
        <h3 style="margin: 0;">{{ poll.author_name }}</h3>
      </div>

      <h2>{{ poll.question }}</h2>

      {% if poll.question_image %}
        <img class="question-image" src="{{ poll.question_image }}" alt="Poll image" />
      {% endif %}

      <div class="poll-options">
        {% for opt in poll.options %}
          <h4>
            <button
              type="button"
              class="vote-btn"
              data-qn="{{ poll.questionid }}"
              data-opt="{{ opt.optionid }}"
              id="btn-{{ poll.questionid }}-{{ opt.optionid }}"
              onclick="vote(this)">
              {{ opt.optionDescription }}
            </button>
            <span id="pct-{{ poll.questionid }}-{{ opt.optionid }}">
              {{ opt.percentage|floatformat:1 }}%
            </span>

            {% if opt.image %}
              <img src="{{ opt.image }}" alt="Option image">
            {% endif %}
          </h4>
        {% endfor %}
      </div>
    </div>
  {% endfor %}

  <script>
    const VOTE_URL    = "{% url 'vote' %}";
    const LIKE_URL    = "{% url 'poll_like' %}";
    const DISLIKE_URL = "{% url 'poll_dislike' %}";
    const STATUS_URL  = "{% url 'poll_status' %}";

    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach(c => {
          c = c.trim();
          if (c.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(c.slice(name.length + 1));
          }
        });
      }
      return cookieValue;
    }
    const CSRF_TOKEN = getCookie("csrftoken");

    // storage keys & sets
    const votedKey    = "votedPolls";
    const likedKey    = "likedPolls";
    const dislikedKey = "dislikedPolls";

    const votedSet     = new Set(JSON.parse(sessionStorage.getItem(votedKey)    || "[]"));
    const likedSet     = new Set(JSON.parse(sessionStorage.getItem(likedKey)    || "[]"));
    const dislikedSet  = new Set(JSON.parse(sessionStorage.getItem(dislikedKey) || "[]"));

    document.addEventListener("DOMContentLoaded", () => {
      // disable already-used buttons
      votedSet.forEach(qn => {
        document.querySelectorAll(`.vote-btn[data-qn='${qn}']`)
                .forEach(b => b.classList.add("disabled"));
      });
      likedSet.forEach(qn => {
        document.querySelector(`.like-btn[data-qn='${qn}']`)
                .classList.add("disabled");
      });
      dislikedSet.forEach(qn => {
        document.querySelector(`.dislike-btn[data-qn='${qn}']`)
                .classList.add("disabled");
      });

      // prime live status immediately
      fetchStatus();
    });

    // apply status data to DOM
    function applyStatus(data) {
      Object.entries(data).forEach(([qn, info]) => {
        // likes/dislikes
        const l = document.getElementById(`like-count-${qn}`);
        const d = document.getElementById(`dislike-count-${qn}`);
        if (l) l.textContent    = info.likes;
        if (d) d.textContent    = info.dislikes;
        // vote percentages
        Object.entries(info.percentages).forEach(([optid, pct]) => {
          const span = document.getElementById(`pct-${qn}-${optid}`);
          if (span) span.textContent = `${pct}%`;
        });
      });
    }

    // fetch live status
    function fetchStatus() {
      fetch(STATUS_URL, {
        headers: { "X-CSRFToken": CSRF_TOKEN }
      })
      .then(r => r.json())
      .then(applyStatus)
      .catch(console.error);
    }
    // refresh every 5s
    setInterval(fetchStatus, 5000);

    // voting
    function vote(btn) {
      const qn  = btn.dataset.qn;
      const opt = btn.dataset.opt;
      if (votedSet.has(qn)) return;

      fetch(VOTE_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken":   CSRF_TOKEN
        },
        body: JSON.stringify({ questionid: qn, optionid: opt })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) return alert(data.error);
        applyStatus({ [qn]: data });  // update only this poll‚Äôs percentages
        document.querySelectorAll(`.vote-btn[data-qn='${qn}']`)
                .forEach(b => b.classList.add("disabled"));
        votedSet.add(qn);
        sessionStorage.setItem(votedKey, JSON.stringify([...votedSet]));
      })
      .catch(console.error);
    }

    // reaction handler
    function react(qn, url, spanId, storeSet, storeKey, oppositeSet, oppositeBtnClass) {
      if (storeSet.has(qn) || oppositeSet.has(qn)) return;

      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken":   CSRF_TOKEN
        },
        body: JSON.stringify({ questionid: qn })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) return alert(data.error);
        document.getElementById(spanId).textContent = data.count;
        // disable both reaction buttons
        document.querySelector(`.${oppositeBtnClass}[data-qn='${qn}']`)
                .classList.add("disabled");
        document.querySelector(`.${storeKey.replace("Polls","Btn").toLowerCase()}[data-qn='${qn}']`)
                .classList.add("disabled");
        storeSet.add(qn);
        sessionStorage.setItem(storeKey, JSON.stringify([...storeSet]));
      })
      .catch(console.error);
    }

    // wire up like/dislike clicks
    document.body.addEventListener("click", e => {
      if (e.target.matches(".like-btn")) {
        const qn = e.target.dataset.qn;
        react(qn, LIKE_URL, `like-count-${qn}`, likedSet, likedKey, dislikedSet, "dislike-btn");
      }
      if (e.target.matches(".dislike-btn")) {
        const qn = e.target.dataset.qn;
        react(qn, DISLIKE_URL, `dislike-count-${qn}`, dislikedSet, dislikedKey, likedSet, "like-btn");
      }
    });
  </script>
</body>
</html>
